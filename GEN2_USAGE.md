# Генератор этикеток gen2.py - Руководство по использованию

## Описание

`gen2.py` - это скрипт для генерации этикеток в многостраничный PDF документ с применением PDF шаблонов. Скрипт поддерживает два типа шаблонов:

1. **Один шаблон на одну этикетку** (`single`) - каждая этикетка создается на отдельной странице
2. **Шаблон с несколькими этикетками** (`multiple`) - несколько этикеток размещаются на одной странице

## Установка зависимостей

```bash
pip install -r requirements.txt
```

Основные зависимости:
- `pylibdmtx` - для генерации DataMatrix кодов
- `reportlab` - для работы с PDF
- `PyPDF2` - для работы с PDF шаблонами
- `Pillow` - для обработки изображений

## Синтаксис

```bash
python gen2.py <csv_file> <template_pdf> <output_pdf> [опции]
```

## Обязательные параметры

- `csv_file` - путь к CSV файлу с данными (разделитель - табуляция)
- `template_pdf` - путь к PDF шаблону
- `output_pdf` - путь к выходному PDF файлу
- `--template-type` - тип шаблона: `single` или `multiple`
- `--dm-x` - X координата DataMatrix (слева сверху) в мм
- `--dm-y` - Y координата DataMatrix (слева сверху) в мм
- `--dm-size` - размер DataMatrix кода в мм

## Дополнительные параметры

### Для множественного шаблона
- `--labels-horizontal` - количество этикеток по горизонтали (по умолчанию: 1)
- `--labels-vertical` - количество этикеток по вертикали (по умолчанию: 1)

### Размеры и отступы для множественного шаблона
- `--label-width` - ширина отдельной этикетки в мм (если не указано, вычисляется автоматически)
- `--label-height` - высота отдельной этикетки в мм (если не указано, вычисляется автоматически)
- `--label-margin-left` - отступ слева от края страницы до первой этикетки в мм (по умолчанию: 0)
- `--label-margin-top` - отступ сверху от края страницы до первой этикетки в мм (по умолчанию: 0)
- `--label-spacing-horizontal` - расстояние между этикетками по горизонтали в мм (по умолчанию: 0)
- `--label-spacing-vertical` - расстояние между этикетками по вертикали в мм (по умолчанию: 0)

### Параметры CSV
- `--datamatrix-column` - номер столбца CSV файла для DataMatrix (начиная с 0, по умолчанию: 0)

### Параметры текстового поля
- `--text-column` - номер столбца CSV файла для текста (начиная с 0, если не указано, текст не добавляется)
- `--text-start` - начальная позиция для извлечения текста (начиная с 0, по умолчанию: 0)
- `--text-length` - длина извлекаемого текста (если не указано, берется до конца строки)
- `--text-font-size` - размер шрифта для текста в пунктах (по умолчанию: 12)
- `--text-offset-x` - смещение текста по X относительно DataMatrix в мм (по умолчанию: 0)
- `--text-offset-y` - смещение текста по Y относительно DataMatrix в мм (по умолчанию: 0)
- `--text-color` - цвет текста (по умолчанию: black)

### Дополнительные настройки
- `--dpi` - DPI для генерации изображений (по умолчанию: 300)

## Примеры использования

### Пример 1: Один шаблон на одну этикетку

```bash
python gen2.py data.csv maket.pdf output.pdf \
    --template-type single \
    --dm-x 10 \
    --dm-y 5 \
    --dm-size 15 \
    --datamatrix-column 0
```

### Пример 2: Шаблон с несколькими этикетками (2x2)

```bash
python gen2.py data.csv maket.pdf output.pdf \
    --template-type multiple \
    --labels-horizontal 2 \
    --labels-vertical 2 \
    --dm-x 5 \
    --dm-y 3 \
    --dm-size 12 \
    --datamatrix-column 0
```

### Пример 2.1: Шаблон с заданными размерами и отступами

```bash
python gen2.py data.csv maket.pdf output.pdf \
    --template-type multiple \
    --labels-horizontal 3 \
    --labels-vertical 6 \
    --label-width 50 \
    --label-height 30 \
    --label-margin-left 10 \
    --label-margin-top 15 \
    --label-spacing-horizontal 5 \
    --label-spacing-vertical 3 \
    --dm-x 5 \
    --dm-y 3 \
    --dm-size 12 \
    --datamatrix-column 0
```

### Пример 3: Шаблон с несколькими этикетками (3x1)

```bash
python gen2.py data.csv maket.pdf output.pdf \
    --template-type multiple \
    --labels-horizontal 3 \
    --labels-vertical 1 \
    --dm-x 8 \
    --dm-y 2 \
    --dm-size 10 \
    --datamatrix-column 0 \
    --dpi 600
```

### Пример 4: Использование другого столбца для DataMatrix

```bash
python gen2.py data.csv maket.pdf output.pdf \
    --template-type single \
    --dm-x 15 \
    --dm-y 8 \
    --dm-size 18 \
    --datamatrix-column 1
```

### Пример 5: Добавление текстового поля

```bash
python gen2.py data.csv maket.pdf output.pdf \
    --template-type single \
    --dm-x 10 \
    --dm-y 5 \
    --dm-size 15 \
    --datamatrix-column 0 \
    --text-column 2 \
    --text-start 0 \
    --text-length 10 \
    --text-font-size 14 \
    --text-offset-x 20 \
    --text-offset-y 0 \
    --text-color black
```

### Пример 6: Множественный шаблон с текстом

```bash
python gen2.py data.csv maket.pdf output.pdf \
    --template-type multiple \
    --labels-horizontal 3 \
    --labels-vertical 6 \
    --dm-x 5 \
    --dm-y 3 \
    --dm-size 12 \
    --datamatrix-column 0 \
    --text-column 2 \
    --text-start 0 \
    --text-length 8 \
    --text-font-size 10 \
    --text-offset-x 15 \
    --text-offset-y -5 \
    --text-color black
```

## Формат CSV файла

CSV файл должен использовать разделитель табуляция. Пример:

```
0108809687640804215!O3HX91EE1192ekgC/HwmvlRLnjxBVbaaMT9V71ws70UQXmFIWVtRkig=	08809687640804	PLARECETA Cream
0108809687640804215!lVdZ91EE1192h9I9IkQsqFQ7MvqOJba3J5uV5nvPqKA+7o7hvgzOtDA=	08809687640804	PLARECETA Cream
```

- Первый столбец (индекс 0): данные для DataMatrix кода
- Второй столбец (индекс 1): дополнительная информация
- Третий столбец (индекс 2): название продукта

## Система координат

Координаты DataMatrix указываются в миллиметрах от левого верхнего угла этикетки:

- `--dm-x` - расстояние от левого края
- `--dm-y` - расстояние от верхнего края

## Типы шаблонов

### Single (один шаблон на этикетку)
- Каждая этикетка создается на отдельной странице
- Используется один и тот же шаблон для всех страниц
- Подходит для печати отдельных этикеток

### Multiple (несколько этикеток на шаблоне)
- Несколько этикеток размещаются на одной странице
- Требует указания количества этикеток по горизонтали и вертикали
- Подходит для печати листов с несколькими этикетками

## Автоматическое тестирование

Для тестирования скрипта используйте:

```bash
python example_gen2.py
```

Этот скрипт выполнит несколько тестовых сценариев и создаст примеры PDF файлов.

## Устранение неполадок

### Ошибка "pylibdmtx не установлен"
```bash
pip install pylibdmtx
```

### Ошибка "reportlab не установлен"
```bash
pip install reportlab
```

### Ошибка "PyPDF2 не установлен"
```bash
pip install PyPDF2
```

### Ошибка "CSV файл не найден"
Проверьте путь к CSV файлу и убедитесь, что файл существует.

### Ошибка "PDF шаблон не найден"
Проверьте путь к PDF шаблону и убедитесь, что файл существует и является валидным PDF.

## Особенности

1. **Высокое качество**: DataMatrix коды генерируются в высоком разрешении для четкой печати
2. **Прозрачный фон**: DataMatrix коды имеют прозрачный фон для наложения на шаблоны
3. **Гибкое позиционирование**: Точное позиционирование DataMatrix по координатам
4. **Многостраничность**: Поддержка создания PDF документов с множеством страниц
5. **Автоматическое заполнение**: Этикетки заполняются по строкам и столбцам, автоматически создаются новые страницы при превышении лимита
6. **Текстовые поля**: Поддержка добавления текста из CSV с настраиваемым позиционированием относительно DataMatrix
7. **Гибкое извлечение текста**: Возможность извлечения фрагментов текста с заданной позиции и длины
8. **Совместимость**: Работает с различными PDF шаблонами

## Логика заполнения множественных шаблонов

При использовании `template-type=multiple`:

1. **Заполнение по строкам**: Этикетки заполняются слева направо, затем переходят на следующую строку
2. **Автоматические страницы**: Когда все позиции на странице заполнены, автоматически создается новая страница
3. **Неполные страницы**: Если данных меньше чем помещается на странице, создается страница с частичным заполнением
4. **Позиционирование**: DataMatrix размещается относительно левого верхнего угла каждой этикетки на шаблоне

### Размеры и отступы

- **Автоматические размеры**: Если не указаны `--label-width` и `--label-height`, размеры этикеток вычисляются автоматически на основе размера страницы
- **Заданные размеры**: Можно указать точные размеры этикеток в миллиметрах
- **Отступы**: `--label-margin-left` и `--label-margin-top` задают отступы от краев страницы
- **Расстояния**: `--label-spacing-horizontal` и `--label-spacing-vertical` задают расстояния между этикетками

### Формула позиционирования

Для этикетки в позиции (col, row):
- X = margin_left + col × (label_width + spacing_horizontal)
- Y = page_height - margin_top - (row + 1) × label_height - row × spacing_vertical

## Текстовые поля

### Извлечение текста

Текстовые поля извлекаются из указанного столбца CSV с возможностью:
- **Выбор столбца**: `--text-column` - номер столбца (начиная с 0)
- **Начальная позиция**: `--text-start` - с какого символа начинать извлечение
- **Длина текста**: `--text-length` - сколько символов извлекать (если не указано, до конца строки)

### Позиционирование текста

Текст позиционируется относительно DataMatrix кода:
- **Смещение по X**: `--text-offset-x` - смещение в миллиметрах по горизонтали
- **Смещение по Y**: `--text-offset-y` - смещение в миллиметрах по вертикали
- **Размер шрифта**: `--text-font-size` - размер в пунктах
- **Цвет текста**: `--text-color` - цвет текста

### Формула позиционирования текста

Для текста относительно DataMatrix:
- text_x = dm_x + text_offset_x
- text_y = dm_y + text_offset_y

## Версия

Версия: 2.2  
Автор: Michael Bag
