# Генератор этикеток gen2.py - Руководство по использованию

## Описание

`gen2.py` v2.12 - это продвинутый скрипт для генерации этикеток с DataMatrix кодами (включая GS1 DataMatrix) в многостраничный PDF документ с применением PDF шаблонов. Скрипт поддерживает два типа шаблонов:

1. **Один шаблон на одну этикетку** (`single`) - каждая этикетка создается на отдельной странице
2. **Шаблон с несколькими этикетками** (`multiple`) - несколько этикеток размещаются на одной странице

### Новые возможности v2.12:
- ✅ **Отображение прогресса** с процентами, временем начала и завершения
- ✅ **Конфигурационные файлы JSON** для упрощения использования
- ✅ **Устойчивый парсинг CSV** с поддержкой кавычек в полях
- ✅ **Поддержка путей в конфигах** с приоритетом аргументов командной строки
- ✅ **Команда --show-configs** для просмотра доступных конфигураций

## Установка зависимостей

```bash
pip install -r requirements.txt
```

Основные зависимости:
- `pylibdmtx` - для генерации DataMatrix кодов
- `reportlab` - для работы с PDF
- `PyPDF2` - для работы с PDF шаблонами
- `Pillow` - для обработки изображений

## Синтаксис

```bash
python gen2.py [csv_file] [template_pdf] [output_pdf] [опции]
```

### Использование конфигурационных файлов

```bash
python gen2.py -c config_name.json
```

### Просмотр доступных конфигураций

```bash
python gen2.py --show-configs
```

## Структура папок

Скрипт автоматически работает с папками:

- **`input_data/`** - CSV файлы с данными (разделитель - табуляция)
- **`input_templates/`** - PDF шаблоны для этикеток
- **`temp/`** - временные файлы (создаются и удаляются автоматически)
- **`output/`** - готовые PDF файлы с этикетками
- **`conf/`** - конфигурационные файлы JSON

Если файлы не указаны в командной строке, скрипт автоматически найдет их в соответствующих папках.

## Конфигурационные файлы

Для упрощения использования создайте JSON файл в папке `conf/` с настройками:

```json
{
    "description": "Конфигурация для single шаблона",
    "template_type": "single",
    "csv_file": "input_data/data.csv",
    "template_pdf": "input_templates/maket.pdf",
    "output_pdf": "output/out.pdf",
    "dm_x": 10,
    "dm_y": 5,
    "dm_size": 15,
    "datamatrix_column": 0,
    "text_column": 2,
    "text_start": 0,
    "text_length": 10,
    "text_font_size": 14,
    "text_offset_x": 20,
    "text_offset_y": 0,
    "text_color": "black",
    "dpi": 300
}
```

**Приоритет параметров:** Аргументы командной строки имеют приоритет над значениями в конфигурационном файле.

## Обязательные параметры

- `-t, --template-type` - тип шаблона: `single` или `multiple`
- `-dx, --dm-x` - X координата DataMatrix (слева сверху) в мм
- `-dy, --dm-y` - Y координата DataMatrix (слева сверху) в мм
- `-ds, --dm-size` - размер DataMatrix кода в мм

## Необязательные параметры файлов

- `csv_file` - путь к CSV файлу с данными (если не указан, ищется в `input_data/`)
- `template_pdf` - путь к PDF шаблону (если не указан, ищется в `input_templates/`)
- `output_pdf` - путь к выходному PDF файлу (если не указан, создается в `output/`)

## Дополнительные параметры

### Для множественного шаблона
- `-lh, --labels-horizontal` - количество этикеток по горизонтали (по умолчанию: 1)
- `-lv, --labels-vertical` - количество этикеток по вертикали (по умолчанию: 1)

### Размеры и отступы для множественного шаблона
- `-lw, --label-width` - ширина отдельной этикетки в мм (если не указано, вычисляется автоматически)
- `-lh2, --label-height` - высота отдельной этикетки в мм (если не указано, вычисляется автоматически)
- `-lml, --label-margin-left` - отступ слева от края страницы до первой этикетки в мм (по умолчанию: 0)
- `-lmt, --label-margin-top` - отступ сверху от края страницы до первой этикетки в мм (по умолчанию: 0)
- `-lsh, --label-spacing-horizontal` - расстояние между этикетками по горизонтали в мм (по умолчанию: 0)
- `-lsv, --label-spacing-vertical` - расстояние между этикетками по вертикали в мм (по умолчанию: 0)

### Параметры позиционирования DataMatrix
- `-dx, --dm-x` - X координата DataMatrix (слева сверху) в мм
- `-dy, --dm-y` - Y координата DataMatrix (слева сверху) в мм
- `-ds, --dm-size` - размер DataMatrix кода в мм

### Параметры CSV
- `-dc, --datamatrix-column` - номер столбца CSV файла для DataMatrix (начиная с 0, по умолчанию: 0)

### Параметры текстового поля
- `-tc, --text-column` - номер столбца CSV файла для текста (начиная с 0, если не указано, текст не добавляется)
- `-ts, --text-start` - начальная позиция для извлечения текста (начиная с 0, по умолчанию: 0)
- `-tl, --text-length` - длина извлекаемого текста (если не указано, берется до конца строки)
- `-tfs, --text-font-size` - размер шрифта для текста в пунктах (по умолчанию: 12)
- `-tox, --text-offset-x` - смещение текста по X относительно DataMatrix в мм (по умолчанию: 0)
- `-toy, --text-offset-y` - смещение текста по Y относительно DataMatrix в мм (по умолчанию: 0)
- `-tcl, --text-color` - цвет текста (по умолчанию: black)

### Дополнительные настройки
- `-d, --dpi` - DPI для генерации изображений (по умолчанию: 300)
- `-c, --config` - путь к файлу конфигурации JSON
- `--show-configs` - показать доступные примеры конфигураций и выйти
- `-v, --version` - показать версию программы

## Примеры использования

### Пример 1: Использование конфигурационного файла

```bash
# Использование готовой конфигурации
python gen2.py -c single_template.json
python gen2.py -c multiple_template.json
```

### Пример 2: Автоматический поиск файлов

```bash
# Все файлы берутся автоматически из папок
python gen2.py -t single -dx 10 -dy 5 -ds 15 -dc 0
```

### Пример 3: Один шаблон на одну этикетку

```bash
python gen2.py data.csv maket.pdf output.pdf \
    -t single \
    -dx 10 \
    -dy 5 \
    -ds 15 \
    -dc 0
```

### Пример 4: Шаблон с несколькими этикетками (2x2)

```bash
python gen2.py data.csv maket.pdf output.pdf \
    -t multiple \
    -lh 2 \
    -lv 2 \
    -dx 5 \
    -dy 3 \
    -ds 12 \
    -dc 0
```

### Пример 5: Автоматический поиск с множественным шаблоном

```bash
# Автоматически найдет CSV в input_data/ и PDF в input_templates/
python gen2.py -t multiple -lh 3 -lv 6 -dx 5 -dy 3 -ds 12 -dc 0
```

### Пример 6: Шаблон с заданными размерами и отступами

```bash
python gen2.py data.csv maket.pdf output.pdf \
    -t multiple \
    -lh 3 \
    -lv 6 \
    -lw 50 \
    -lh2 30 \
    -lml 10 \
    -lmt 15 \
    -lsh 5 \
    -lsv 3 \
    -dx 5 \
    -dy 3 \
    -ds 12 \
    -dc 0
```

### Пример 7: Шаблон с несколькими этикетками (3x1)

```bash
python gen2.py data.csv maket.pdf output.pdf \
    -t multiple \
    -lh 3 \
    -lv 1 \
    -dx 8 \
    -dy 2 \
    -ds 10 \
    -dc 0 \
    -d 600
```

### Пример 8: Использование другого столбца для DataMatrix

```bash
python gen2.py data.csv maket.pdf output.pdf \
    -t single \
    -dx 15 \
    -dy 8 \
    -ds 18 \
    -dc 1
```

### Пример 9: Добавление текстового поля

```bash
python gen2.py data.csv maket.pdf output.pdf \
    -t single \
    -dx 10 \
    -dy 5 \
    -ds 15 \
    -dc 0 \
    -tc 2 \
    -ts 0 \
    -tl 10 \
    -tfs 14 \
    -tox 20 \
    -toy 0 \
    -tcl black
```

### Пример 10: Множественный шаблон с текстом

```bash
python gen2.py data.csv maket.pdf output.pdf \
    -t multiple \
    -lh 3 \
    -lv 6 \
    -dx 5 \
    -dy 3 \
    -ds 12 \
    -dc 0 \
    -tc 2 \
    -ts 0 \
    -tl 8 \
    -tfs 10 \
    -tox 15 \
    -toy -5 \
    -tcl black
```

## Формат CSV файла

### Поддерживаемые форматы

Скрипт автоматически определяет формат CSV файла и поддерживает:

1. **Обычные CSV файлы** с разделителем табуляция
2. **CSV файлы из Excel** с экранированными кавычками и точкой с запятой в конце строки
3. **Файлы с разделителем точка с запятой** (автоопределение)
4. **Файлы с разделителем запятая** (автоопределение)

### Примеры форматов

**Обычный формат (табуляция):**
```
0108809687640804215!O3HX91EE1192ekgC/HwmvlRLnjxBVbaaMT9V71ws70UQXmFIWVtRkig=	08809687640804	PLARECETA Cream
0108809687640804215!lVdZ91EE1192h9I9IkQsqFQ7MvqOJba3J5uV5nvPqKA+7o7hvgzOtDA=	08809687640804	PLARECETA Cream
```

**Excel формат (с кавычками и точкой с запятой):**
```
"0108809687640804215!O3HX91EE1192ekgC/HwmvlRLnjxBVbaaMT9V71ws70UQXmFIWVtRkig="	08809687640804	PLARECETA Cream;
"0108809687640804215!lVdZ91EE1192h9I9IkQsqFQ7MvqOJba3J5uV5nvPqKA+7o7hvgzOtDA="	08809687640804	PLARECETA Cream;
```

### Структура данных

- **Первый столбец (индекс 0)**: данные для DataMatrix кода
- **Второй столбец (индекс 1)**: дополнительная информация  
- **Третий столбец (индекс 2)**: название продукта

### Особенности обработки

- **Экранированные кавычки**: Автоматически обрабатываются (`""` → `"`)
- **Научная нотация**: Строки с числами в формате `1,0452E+17` автоматически пропускаются
- **Пустые строки**: Игнорируются
- **Кодировка**: Поддерживается UTF-8

### Кодировка CSV файлов

**⚠️ КРИТИЧЕСКИ ВАЖНО: Все CSV файлы должны быть в кодировке UTF-8**

#### Поддерживаемая кодировка:
- ✅ **UTF-8** - единственная поддерживаемая кодировка
- ✅ **Кириллица** - полная поддержка русских символов
- ✅ **Unicode** - поддержка специальных символов и эмодзи

#### Как правильно сохранить CSV файл:

**В Microsoft Excel:**
1. Откройте файл в Excel
2. Выберите "Файл" → "Сохранить как"
3. Выберите тип файла: **"CSV UTF-8 (разделители - запятые)"**
4. Сохраните файл

**В LibreOffice Calc:**
1. Откройте файл в LibreOffice Calc
2. Выберите "Файл" → "Сохранить как"
3. Выберите тип файла: **"Текст CSV (.csv)"**
4. В настройках экспорта выберите кодировку: **"UTF-8"**
5. Сохраните файл

**В текстовых редакторах:**
- **Notepad++**: Кодировка → "Преобразовать в UTF-8"
- **VS Code**: В правом нижнем углу выберите "UTF-8"
- **Sublime Text**: File → Save with Encoding → "UTF-8"

#### Проверка кодировки:
Если русские символы отображаются как "????" или "РўСЃС‚", значит файл сохранен в неправильной кодировке. Пересохраните файл в UTF-8.

#### Примеры правильной кодировки:
```
01046000000000121=ABC1234567890	Тестовый продукт	Дополнительная информация
01046000000000122=DEF9876543210	Продукт с кириллицей	Информация на русском
```

**Поддержка GS1 DataMatrix:** Скрипт поддерживает генерацию GS1 DataMatrix кодов с Application Identifiers (AI) и FNC1 символами.

## Система координат

Координаты DataMatrix указываются в миллиметрах от левого верхнего угла этикетки:

- `--dm-x` - расстояние от левого края
- `--dm-y` - расстояние от верхнего края

## Типы шаблонов

### Single (один шаблон на этикетку)
- Каждая этикетка создается на отдельной странице
- Используется один и тот же шаблон для всех страниц
- Подходит для печати отдельных этикеток

### Multiple (несколько этикеток на шаблоне)
- Несколько этикеток размещаются на одной странице
- Требует указания количества этикеток по горизонтали и вертикали
- Подходит для печати листов с несколькими этикетками

## Автоматическое тестирование

Для тестирования скрипта используйте:

```bash
python example_gen2.py
```

Этот скрипт выполнит несколько тестовых сценариев и создаст примеры PDF файлов.

## Устранение неполадок

### Ошибка "pylibdmtx не установлен"
```bash
pip install pylibdmtx
```

### Ошибка "reportlab не установлен"
```bash
pip install reportlab
```

### Ошибка "PyPDF2 не установлен"
```bash
pip install PyPDF2
```

### Ошибка "CSV файл не найден"
Проверьте путь к CSV файлу и убедитесь, что файл существует.

### Ошибка "PDF шаблон не найден"
Проверьте путь к PDF шаблону и убедитесь, что файл существует и является валидным PDF.

## Особенности

1. **Поддержка GS1 DataMatrix**: Генерация настоящих DataMatrix кодов (ISO/IEC 16022) с поддержкой GS1 формата
2. **Отображение прогресса**: Визуальный прогресс-бар с процентами, временем начала и завершения
3. **Конфигурационные файлы**: JSON конфигурации для упрощения использования
4. **Устойчивый парсинг CSV**: Поддержка кавычек в полях CSV файлов
5. **Высокое качество**: DataMatrix коды генерируются в высоком разрешении (300 DPI) для четкой печати
6. **Прозрачный фон**: DataMatrix коды имеют прозрачный фон для наложения на шаблоны
7. **Гибкое позиционирование**: Точное позиционирование DataMatrix по координатам в миллиметрах
8. **Многостраничность**: Поддержка создания PDF документов с множеством страниц
9. **Автоматическое заполнение**: Этикетки заполняются по строкам и столбцам, автоматически создаются новые страницы при превышении лимита
10. **Текстовые поля**: Поддержка добавления текста из CSV с настраиваемым позиционированием относительно DataMatrix
11. **Гибкое извлечение текста**: Возможность извлечения фрагментов текста с заданной позиции и длины
12. **Совместимость**: Работает с различными PDF шаблонами

## Логика заполнения множественных шаблонов

При использовании `template-type=multiple`:

1. **Заполнение по строкам**: Этикетки заполняются слева направо, затем переходят на следующую строку
2. **Автоматические страницы**: Когда все позиции на странице заполнены, автоматически создается новая страница
3. **Неполные страницы**: Если данных меньше чем помещается на странице, создается страница с частичным заполнением
4. **Позиционирование**: DataMatrix размещается относительно левого верхнего угла каждой этикетки на шаблоне

### Размеры и отступы

- **Автоматические размеры**: Если не указаны `--label-width` и `--label-height`, размеры этикеток вычисляются автоматически на основе размера страницы
- **Заданные размеры**: Можно указать точные размеры этикеток в миллиметрах
- **Отступы**: `--label-margin-left` и `--label-margin-top` задают отступы от краев страницы
- **Расстояния**: `--label-spacing-horizontal` и `--label-spacing-vertical` задают расстояния между этикетками

### Формула позиционирования

Для этикетки в позиции (col, row):
- X = margin_left + col × (label_width + spacing_horizontal)
- Y = page_height - margin_top - (row + 1) × label_height - row × spacing_vertical

## Текстовые поля

### Извлечение текста

Текстовые поля извлекаются из указанного столбца CSV с возможностью:
- **Выбор столбца**: `--text-column` - номер столбца (начиная с 0)
- **Начальная позиция**: `--text-start` - с какого символа начинать извлечение
- **Длина текста**: `--text-length` - сколько символов извлекать (если не указано, до конца строки)

### Позиционирование текста

Текст позиционируется относительно DataMatrix кода:
- **Смещение по X**: `--text-offset-x` - смещение в миллиметрах по горизонтали
- **Смещение по Y**: `--text-offset-y` - смещение в миллиметрах по вертикали
- **Размер шрифта**: `--text-font-size` - размер в пунктах
- **Цвет текста**: `--text-color` - цвет текста

### Формула позиционирования текста

Для текста относительно DataMatrix:
- text_x = dm_x + text_offset_x
- text_y = dm_y + text_offset_y

## Отображение прогресса

В версии 2.12 добавлено отображение прогресса обработки:

```
Прогресс: [██████████████████████████████] 100.0% (300/300) | Начало: 16:20:40 | Прошло: 13.3 сек
```

### Финальный отчет:
```
============================================================
ГЕНЕРАЦИЯ ЗАВЕРШЕНА
============================================================
Время начала:     16:20:40
Время завершения: 16:20:55
Общее время:      14.6 сек
Обработано записей: 300
Создано страниц:  19
Выходной файл:    output/test251020_multi_2.pdf
============================================================
```

## Версия

Версия: 2.12

## Автор проекта

**Michael BAG**  
📧 E-mail: mk@p7net.ru  
💬 Telegram: https://t.me/michaelbag

---

*Генератор этикеток с DataMatrix кодами для создания многостраничных PDF документов с использованием шаблонов.*
